<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-07-06 Thu 08:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Coreboot for x230</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="kb" />
<meta name="description" content="Getting Coreboot onto Lenovo x230"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta charset="utf-8">

<meta name="author" content="Kenny Ballou">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>~kb</title>

<link rel="canonical" href="/" />
<link href="/index.xml" rel="alternate" type="application/rss+xml"
      title="~kb/blog" />

<link rel="stylesheet" href="/css/simple.css" />
<link rel="stylesheet" href="/css/simple.add.css" />
<link rel="stylesheet" href="/css/katex.css" />
<link rel="stylesheet" href="/css/fa-all.css" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<script defer type="text/javascript" src="/js/katex.js"></script>
<script defer type="text/javascript" src="/js/katex-render.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://kennyballou.com/blog"> UP </a>
 |
 <a accesskey="H" href="https://kennyballou.com/"> HOME </a>
</div><header id="" class="status">
<nav>
  <a href="/">
    <i class="fade fas fa-home"></i>
  </a>
  <a href="/about.html">
    <i class="fade fas fa-user-circle"></i>
  </a>
  <a href="https://git.sr.ht/~kennyballou/"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fas fa-code-branch fa-1x"></i>
  </a>
  <a href="https://github.com/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-github fa-1x"></i>
  </a>
  <a href="https://bitbucket.org/kballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-bitbucket fa-1x"></i>
  </a>
  <a href="https://linkedin.com/in/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-linkedin-in fa-1x"></i>
  </a>
  <a href="/support.html">
    <i class="fade fas fa-heart fa-1x"></i>
  </a>
  <a href="/resume.pdf"
     target="_blank">
    <i class="fade far fa-file-pdf"></i>
  </a>
  <a href="/B74CC4B41148C3DB364BC21182D94B35744E1B34.asc"
     target="_blank">
    <i class="fade fas fa-key"></i>
  </a>
  <a href="/index.xml" rel="alternate"
     type="application/rss+xml">
    <i class="fade fas fa-rss fa-1x"></i>
  </a>
</nav>
</header>
<div id="main">
<h1 class="title">Coreboot for x230</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org9436cda">Coreboot</a></li>
<li><a href="#org6eaf1ee">Motivation</a></li>
<li><a href="#org4558e7c">Necessary Equipment</a></li>
<li><a href="#org38eb148">Disassembly and BIOS Access</a>
<ul>
<li><a href="#orgad9959d">Connecting the Raspberry Pi to the SOIC Clip</a></li>
<li><a href="#orgf61286f">Using the Raspberry Pi</a></li>
</ul>
</li>
<li><a href="#orgf8493da">Configuration and Compilation</a>
<ul>
<li><a href="#org93e7e9b">Configuration</a></li>
<li><a href="#org486c9b6">Compilation</a></li>
</ul>
</li>
<li><a href="#orga163fd7">Flashing the New Image</a></li>
<li><a href="#org8d1f8ff">Common Problems</a></li>
<li><a href="#org2e99b13">Summary and Auxiliary Advice</a></li>
<li><a href="#org6aaec18">References</a></li>
</ul>
</div>
</div>
<div class="PREVIEW">
<p>
In this post, we will go through the steps to get <a href="https://www.coreboot.org">coreboot</a> compiled and
installed on a <a href="http://shop.lenovo.com/us/en/laptops/thinkpad/x-series/x230/">Lenovo x230</a> laptop.  This is a somewhat lengthy and involved
process that is not for the faint of heart.  It is very possible to ruin or
otherwise brick your laptop performing these steps improperly or even properly!
You have been warned.
</p>

</div>

<figure>

<div id="orge84b141" class="figure">
<p><img src="./../../../../media/coreboot-x230-1.png" alt="coreboot-x230-1.png" width="70%" />
</p>
</div>
</figure>

<div id="outline-container-org9436cda" class="outline-2">
<h2 id="org9436cda">Coreboot</h2>
<div class="outline-text-2" id="text-org9436cda">
<blockquote>
<p>
coreboot is an extended firmware platform that delivers a lightning fast and
secure boot experience on modern computers and embedded systems
--<a href="https://www.coreboot.org">coreboot project</a>
</p>
</blockquote>

<p>
Coreboot is an OpenSource firmware alternative that supports a number of modern
computers and embedded systems.  It can replace your system's
<a href="https://en.wikipedia.org/wiki/BIOS">BIOS</a> with a faster and more secure platform.  It can be preloaded
with a number of payloads, e.g., <a href="https://www.seabios.org/SeaBIOS">SeaBIOS</a> or
<a href="http://www.tianocore.org/">tianocore</a>, and/or it can come with some additional payloads,
e.g., <a href="http://www.memtest.org/">memtest86+</a>.
</p>
</div>
</div>

<div id="outline-container-org6eaf1ee" class="outline-2">
<h2 id="org6eaf1ee">Motivation</h2>
<div class="outline-text-2" id="text-org6eaf1ee">
<p>
Why replace the default BIOS image in the first place? There are several
motivations for doing this.  For one, it's <a href="https://duckduckgo.com/?q=lenovo+whitelist+bios">well
documented</a> that Lenovo installs a device whitelist onto its systems,
disabling the computer if a third-party peripheral is installed, which can
include WiFi cards and SSD's.  If you're more adventurous and want to replace
the x230 screen with that of an x240, the whitelist will also get in the way.
By replacing the BIOS entirely, this whitelist problem will be avoided.
</p>

<p>
Furthermore, in older laptops, x200/1 for example, it's possible to replace the
disastrous <a href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology">Intel ME</a> platform.  This is, unfortunately,
(currently) impossible on the x230 and later.  That is, removing the ME code
will make the laptop effectively unusable.
</p>
</div>
</div>

<div id="outline-container-org4558e7c" class="outline-2">
<h2 id="org4558e7c">Necessary Equipment</h2>
<div class="outline-text-2" id="text-org4558e7c">
<p>
Before we go into the actual steps, let's take a moment to gather all the
necessary equipment.  Disassembly is necessary because the BIOS chip is locked
and not accessible from software flashers like <a href="https://www.flashrom.org/Flashrom">flashrom</a>.
However, desoldering will not be necessary.
</p>

<ul class="org-ul">
<li><p>
SPI Flash Programmer
</p>

<p>
This guide will perform the ROM flashing via the GPIO headers of a
<a href="https://www.raspberrypi.org/products/raspberry-pi-2-model-b/">Raspberry Pi 2</a> (RPI-1 should work, but different pinouts
are required).
</p></li>

<li><p>
<a href="https://www.sparkfun.com/products/13153">SOIC-8 Clip</a>
</p>

<p>
This clip will be used for interfacing with the BIOS chip and the SPI
programmer.  They are sometimes available for less (with longer shipping
times) from <a href="https://ebay.com">eBay</a>.
</p></li>

<li><p>
Some <a href="https://www.amazon.com/Elegoo-120pcs-Multicolored-Breadboard-arduino/dp/B01EV70C78"><i>short</i> cables</a>
</p>

<p>
These cables will connect the SOIC chip to the GPIO headers of the Raspberry
Pi.  It is important that they are short, no more than 25cm or so.
</p></li>

<li><p>
<a href="https://www.amazon.com/Professional-Non-Abrasive-Spudgers-Anti-Static-Tweezers/dp/B00PHNMEMC">Plastic opening tools</a>
</p>

<p>
After not having these for too long, I can't recommend these enough for
opening up laptops and other devices.
</p></li>

<li><p>
A precision Phillips screwdriver
</p>

<p>
A percision set will be better, used for disassembling the laptop.
</p></li>

<li><p>
A magnifying lens
</p>

<p>
The specific chip found in <i>your</i> x230 may be different from mine.  A
magnifying lens will be helpful in determining the exact version.
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org38eb148" class="outline-2">
<h2 id="org38eb148">Disassembly and BIOS Access</h2>
<div class="outline-text-2" id="text-org38eb148">
<p>
<a href="http://www.myfixguide.com/manual/lenovo-thinkpad-x230-disassembly-clean-cooling-fan-remove-keyboard/">Steps</a> and <a href="https://www.ifixit.com/Device/Lenovo_Thinkpad_x230">manuals</a> for
disassembling the laptop can be found with a simple search.  However, it's only
necessary to remove the keyboard and the palm rest to gain access to the BIOS
chip.  Of course, remove the battery and power supply before opening the
laptop.  I personally, removed the hard drive and WiFi card as well, I wanted
nothing attached while working.
</p>

<figure>

<div id="org1d2a453" class="figure">
<p><img src="./../../../../media/coreboot-x230-2.png" alt="coreboot-x230-2.png" width="30%" />
</p>
</div>
</figure>

<p>
You will notice there are two chips in the above figure.  The combination of
these two chips is what makes up the BIOS (and the Intel ME) for the x230. <i>We
will be dealing exclusively with the /top</i> chip/ (one closest to the screen).
</p>

<p>
Once we have physical access to the top chip, use the magnifying glass to read
the <i>tiny</i> print of the chip.  We need to know the precise version of the chip
to remove any future guesswork from the process, especially for disaster
recovery.
</p>

<p>
If you are unable to read the version of the chip, there are steps we can take
to proceed, but it will be far more tedious and less comfortable.
</p>
</div>

<div id="outline-container-orgad9959d" class="outline-3">
<h3 id="orgad9959d">Connecting the Raspberry Pi to the SOIC Clip</h3>
<div class="outline-text-3" id="text-orgad9959d">
<p>
Next, we will be connecting the Raspberry Pi with the cables and clips to the
BIOS chip.
</p>

<blockquote>
<p>
I found this to be the most difficult of the entire process.  Finding a solid
source for the documentation on the chip and the GPIO headers was incredibly
difficult the first time around.
</p>
</blockquote>

<p>
First, get <a href="http://www.raspberrypi-spy.co.uk/wp-content/uploads/2014/07/Raspberry-Pi-GPIO-Layout-Worksheet.pdf">GPIO header diagram</a> for your
Raspberry Pi model.
</p>

<p>
Next, cross-reference the header diagram with your chip's spec sheet.  It
should be in the list at <a href="http://www.alldatasheet.com">All Data Sheet</a>.  Specifically, I
found mine <a href="http://html.alldatasheet.com/html-pdf/575458/MCNIX/MX25L3208EM2I12G/1149/7/MX25L3208EM2I12G.html">here</a>.  It's very likely, yours
will be similar.  Cross reference the "Pin Configuration" page with the GPIO
header diagram to discern the proper connections.
</p>

<p>
The pin arrangement that I used was the following (using the notch on the chip
for starting):
</p>

<ul class="org-ul">
<li>1: GPIO 26</li>

<li>2: GPIO 19</li>

<li>3: Not Connected</li>

<li>4: GPIO 17</li>

<li>5: GPIO 21</li>

<li>6: GPIO 23</li>

<li>7: Not Connected</li>

<li>8: GPIO 25</li>
</ul>
</div>
</div>

<div id="outline-container-orgf61286f" class="outline-3">
<h3 id="orgf61286f">Using the Raspberry Pi</h3>
<div class="outline-text-3" id="text-orgf61286f">
<figure>

<div id="orge8e873c" class="figure">
<p><img src="./../../../../media/coreboot-x230-3.png" alt="coreboot-x230-3.png" width="70%" />
</p>
</div>
</figure>

<blockquote>
<p>
Before connecting the clip, it's imperative to remove all external power
sources.  The Raspberry Pi will be providing power to the ROM chip, any
external current can and most likely <i>will</i> brick your laptop.
</p>
</blockquote>

<p>
Attach the clip to the chip and power on the Raspberry Pi.  Before you are able
to read the chip, you may need to install <a href="https://www.flashrom.org/Flashrom">flashrom</a> and ensure
your kernel has SPI enabled.  Most distributions will have it on by default.  An
easy way to check is to list the contents of <code>/dev</code> and look for <code>spi</code> devices,
since the chip is connected, there should be one.
</p>

<p>
Before we begin the process of flashing, let's inspect the ROM itself.  First,
simply run flashrom, specifying the SPI device as the programmer:
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3205(A)" (4096 kB, SPI) on linux_spi.
Found Macronix flash chip "MX25L3205D/MX25L3208D" (4096 kB, SPI) on linux_spi.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Found Macronix flash chip "MX25L3273E" (4096 kB, SPI) on linux_spi.
Multiple flash chip definitions match the detected chip(s): "MX25L3205(A)", "MX25L3205D/MX25L3208D", "MX25L3206E/MX25L3208E", "MX25L3273E"
Please specify which chip definition to use with the -c &lt;chipname&gt; option.
</pre>

<blockquote>
<p>
If you are seeing numbers like 8192 kB, you're reading the wrong chip!
Disconnect and attach to the other.
</p>
</blockquote>

<p>
If you were able to read the chip number, pass it along, and try again:
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0 \
           --chip "MX25L3206E/MX25L3208E"
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
</pre>

<p>
Now, we will want to create a back up image of the ROM, but we also want to
verify we are reading correctly:
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0 \
           --chip "MX25L3206E/MX25L3208E" \
           --read original.1.rom
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Reading flash... done.

# flashrom --programmer linux_spi:dev=/dev/spidev0.0 \
           --chip "MX25L3206E/MX25L3208E" \
           --read original.2.rom
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Reading flash... done.

# diff original.1.rom original.2.rom
</pre>

<blockquote>
<p>
Again, if the size of <code>original.1.rom</code> and <code>original.2.rom</code> are 8MB, you're
reading the wrong chip, move the clip to the other chip and repeat the above
steps!
</p>
</blockquote>

<p>
If you get no output from the last command, we should be set, or it means we're
reading both incorrectly.  However, it's more likely flashrom will complain
first.
</p>

<p>
Keep at least one of the images around just in case this fails and you need to
attempt recovery.
</p>

<blockquote>
<p>
If you were unable to read the serial number off the chip, perform the read 4
to 8 times, once or twice for each chip type.
</p>
</blockquote>
</div>
</div>
</div>

<div id="outline-container-orgf8493da" class="outline-2">
<h2 id="orgf8493da">Configuration and Compilation</h2>
<div class="outline-text-2" id="text-orgf8493da">
<p>
Half the battle to getting Coreboot onto your system is properly putting
together the build-tools and compiling the coreboot image.  There already
exists a <a href="https://www.coreboot.org/Build_HOWTO">guide for configuring and building</a> the
Coreboot tool-chain, but for completeness, the basic steps will be copied here.
</p>

<blockquote>
<p>
I'll assume a certain comfortability with GNU/Linux and the GNU GCC and Make
tools.
</p>
</blockquote>

<p>
First up, get a copy of the <a href="https://www.coreboot.org/downloads.html">Coreboot Source</a>:
</p>

<pre class="example">
% git clone --recursive https://review.coreboot.org/coreboot.git
</pre>

<p>
This will get the latest source code of the Coreboot project and also
initialize the project's submodules.
</p>

<p>
Next, we will need to download the blobs archive:
</p>

<pre class="example">
% curl -SLO https://www.coreboot.org/releases/coreboot-blobs-4.5.tar.xz
</pre>

<blockquote>
<p>
The link can be found from the
<a href="https://www.coreboot.org/downloads.html">Coreboot Downloads</a> page.
</p>
</blockquote>

<p>
Now, unpack the blobs into the <code>coreboot/3rdparty/blobs</code> folder:
</p>

<pre class="example">
% tar -xf coreboot-blobs-4.5.tar.xz --strip-components=1 -C coreboot
</pre>

<p>
Now, we can move onto configuring the tool-chain, building the tool-chain, and
finally building the coreboot image itself.
</p>
</div>

<div id="outline-container-org93e7e9b" class="outline-3">
<h3 id="org93e7e9b">Configuration</h3>
<div class="outline-text-3" id="text-org93e7e9b">
<pre class="example">
% cd coreboot
</pre>

<p>
We'll start by configuring the compile options for coreboot:
</p>

<pre class="example">
± make menuconfig
</pre>

<p>
OR
</p>

<pre class="example">
± make nconfig
</pre>

<p>
Set the following options:
</p>

<pre class="example">
general  --|
           |-[*] Compress ramstage with LZMA
           |-[*] Include the coreboot .config file into the ROM image
mainboard -|
           |-Mainboard vendor (Lenovo)
           |-Mainboard model (ThinkPad X230)
           |-ROM chip size (12288 KB (12 MB))
           |-(0x100000) Size of CBFS filesystem in ROM
devices ---|
           |-[*] Use native graphics initialization
generic ---|
           |-[*] PS/2 keyboard init
console ---|
           |-[*] Squelch AP CPUs from early console.
           |-[*] Send console output to a CBMEM buffer
           |-[*] Send POST codes to an external device
           |-[*] Send POST codes to an IO port
sys table -|
           |-[*] Generate SMBIOS tables
payload ---|
           |-Add a payload (SeaBIOS)
           |-SeaBIOS version (master)
           |-(10) PS/2 keyboard controller initialization timeout (milliseconds)
           |-[*] Hardware init during option ROM execution
           |-[*] Include generated option rom that implements legacy VGA BIOS compatibility
           |-[*] Use LZMA compression for payloads
</pre>

<p>
These configuration options were borrowed from
<a href="https://www.ericholzbach.net/blog/x230_coreboot/">Unix Blather</a>.
</p>
</div>
</div>

<div id="outline-container-org486c9b6" class="outline-3">
<h3 id="org486c9b6">Compilation</h3>
<div class="outline-text-3" id="text-org486c9b6">
<blockquote>
<p>
If you were thinking of compiling the ROM on the Pi, I recommend you
reconsider.  If you have an exorbitant amount of time to kill, go for it, but
you'll prefer a machine with more power.
</p>
</blockquote>

<p>
From here, we can build the tool-chain:
</p>

<pre class="example">
± make crossgcc-x64 CPUS=$(nproc)
</pre>

<p>
This will only build the tool-chain for the x64 architecture, update as
necessary.
</p>

<p>
<code>CPUS=#</code> is used to specify the parallelization of the tool-build.  This is
unfortunately different from the usual <code>--jobs|-j</code> argument of <code>make</code>, but has
the same effect.
</p>

<p>
Now, we can build the coreboot image itself:
</p>

<pre class="example">
± make -j$(nproc)
</pre>

<p>
This will create <code>build/coreboot.rom</code> image.
</p>

<p>
However, this will <i>not</i> be the image we flash onto our laptop!  Because the
Lenovo x230 comes with the <a href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology">nasty Intel ME</a> and we built the
coreboot image using a stub for the Intel ME section, we need to create a new
image that contains only the Coreboot contents.  To do this, we will use <code>dd</code>
to skip the first 8MB of the image, and only grab the last 4:
</p>

<pre class="example">
± dd if=build/coreboot.rom bs=1M of=/tmp/x230.rom skip=8
</pre>

<p>
This will create a 4MB file in <code>/tmp/</code> named <code>x230.rom</code>.  Finally, copy the new
image to the Raspberry Pi.
</p>
</div>
</div>
</div>

<div id="outline-container-orga163fd7" class="outline-2">
<h2 id="orga163fd7">Flashing the New Image</h2>
<div class="outline-text-2" id="text-orga163fd7">
<p>
After the image is copied to the Pi, we can use flashrom to write the new
image:
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0
           --chip "MX25L3206E/MX25L3208E"
           --write /tmp/x230.rom
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Reading old flash chip contents... done.
Erasing and writing flash chip... Erase/write done.
Verifying flash... VERIFIED.
</pre>

<p>
Flashrom will read back the new contents and verify it was successful, however,
I like the comfort of having done this myself.  This can be accomplished two
ways: using flashrom's <code>--verify</code> option, or reading the image and running
<code>diff</code>:
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0
           --chip "MX25L3206E/MX25L3208E"
           --verify /tmp/x230.rom
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Reading old flash chip contents... done.
Verifying flash... VERIFIED.
</pre>

<p>
OR
</p>

<pre class="example">
# flashrom --programmer linux_spi:dev=/dev/spidev0.0 \
           --chip "MX25L3206E/MX25L3208E" \
           --read /tmp/x230.2.rom
flashrom v0.9.9-r1955 on Linux 4.4.10-1-ARCH (armv7l)
flashrom is free software, get the source code at https://flashrom.org

Calibrating delay loop... OK.
Found Macronix flash chip "MX25L3206E/MX25L3208E" (4096 kB, SPI) on linux_spi.
Reading flash... done.

# diff /tmp/x230.rom /tmp/x230.2.rom
</pre>

<p>
If you get "VERIFIED" or no output, respectively, the contents of the BIOS chip
should be replaced with the Coreboot image.
</p>

<p>
All that's next is to disconnect the chip, reassemble the laptop and hope it
works!
</p>
</div>
</div>

<div id="outline-container-org8d1f8ff" class="outline-2">
<h2 id="org8d1f8ff">Common Problems</h2>
<div class="outline-text-2" id="text-org8d1f8ff">
<p>
If you're having issues flashing or reading your BIOS, check the following:
</p>

<ul class="org-ul">
<li>The chip is getting sufficient power</li>

<li>The wires used to connect the Raspberry Pi and the chip are not <i>too long</i></li>

<li>Make sure your pinout is correct</li>
</ul>

<p>
For some more information, check Flashrom's <a href="https://www.flashrom.org/ISP">in system
programming</a>.
</p>
</div>
</div>

<div id="outline-container-org2e99b13" class="outline-2">
<h2 id="org2e99b13">Summary and Auxiliary Advice</h2>
<div class="outline-text-2" id="text-org2e99b13">
<p>
Hopefully, you're now booting into your x230 with Coreboot.  Enjoy your new
BIOS, whitelist free and awesome!
</p>

<p>
However, if you have issues, e.g., the flashing doesn't go as planned: <i>DO NOT
POWER OFF THE CHIP!</i> Get help from the <a href="irc://irc.freenode.net/coreboot">#coreboot</a> IRC channel
on <a href="https://freenode.net/">freenode</a> or <a href="https://www.coreboot.org/Mailinglist">email the mailing list</a>.
</p>
</div>
</div>

<div id="outline-container-org6aaec18" class="outline-2">
<h2 id="org6aaec18">References</h2>
<div class="outline-text-2" id="text-org6aaec18">
<ul class="org-ul">
<li><a href="https://www.coreboot.org">coreboot homepage</a></li>

<li><a href="http://shop.lenovo.com/us/en/laptops/thinkpad/x-series/x230/">x230 product page</a></li>

<li><a href="https://www.raspberrypi.org/products/raspberry-pi-2-model-b/">Raspberry Pi 2 Model B</a></li>

<li><a href="https://www.sparkfun.com/products/13153">IC Test Clip - SOIC 8-Pin</a></li>

<li><a href="https://en.wikipedia.org/wiki/Intel_Active_Management_Technology">Intel Active Management Technology Wikipedia Post</a></li>

<li><a href="https://www.coreboot.org/Build_HOWTO">Coreboot Build HOWTO</a></li>

<li><a href="https://www.coreboot.org/downloads.html">Coreboot Downloads</a></li>

<li><a href="https://www.flashrom.org/Flashrom">Flashrom Project Homepage</a></li>

<li><a href="http://www.raspberrypi-spy.co.uk/wp-content/uploads/2014/07/Raspberry-Pi-GPIO-Layout-Worksheet.pdf">Raspberry Pi GPIO Header Sheet B/B+</a></li>

<li><a href="https://www.ericholzbach.net/blog/x230_coreboot/">Unix Blather: Coreboot on the Lenovo x230</a></li>
</ul>
</div>
</div>
</div>
<footer id="" class="status">
<footer>
  <p>&copy; 2014-2023 Kenny Ballou.
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Some rights
      reserved.</a></p>
  <p>Powered by <a href="https://gnu.org">GNU/Linux</a></p>
</footer>
</footer>
</body>
</html>
