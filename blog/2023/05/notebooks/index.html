<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2023-07-06 Thu 08:58 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Portable, Repeatable (, and Reproducible) Notebooks</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="kb" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta charset="utf-8">

<meta name="author" content="Kenny Ballou">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>~kb</title>

<link rel="canonical" href="/" />
<link href="/index.xml" rel="alternate" type="application/rss+xml"
      title="~kb/blog" />

<link rel="stylesheet" href="/css/simple.css" />
<link rel="stylesheet" href="/css/simple.add.css" />
<link rel="stylesheet" href="/css/katex.css" />
<link rel="stylesheet" href="/css/fa-all.css" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<script defer type="text/javascript" src="/js/katex.js"></script>
<script defer type="text/javascript" src="/js/katex-render.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2020 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://kennyballou.com/blog"> UP </a>
 |
 <a accesskey="H" href="https://kennyballou.com/"> HOME </a>
</div><header id="" class="status">
<nav>
  <a href="/">
    <i class="fade fas fa-home"></i>
  </a>
  <a href="/about.html">
    <i class="fade fas fa-user-circle"></i>
  </a>
  <a href="https://git.sr.ht/~kennyballou/"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fas fa-code-branch fa-1x"></i>
  </a>
  <a href="https://github.com/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-github fa-1x"></i>
  </a>
  <a href="https://bitbucket.org/kballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-bitbucket fa-1x"></i>
  </a>
  <a href="https://linkedin.com/in/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-linkedin-in fa-1x"></i>
  </a>
  <a href="/support.html">
    <i class="fade fas fa-heart fa-1x"></i>
  </a>
  <a href="/resume.pdf"
     target="_blank">
    <i class="fade far fa-file-pdf"></i>
  </a>
  <a href="/B74CC4B41148C3DB364BC21182D94B35744E1B34.asc"
     target="_blank">
    <i class="fade fas fa-key"></i>
  </a>
  <a href="/index.xml" rel="alternate"
     type="application/rss+xml">
    <i class="fade fas fa-rss fa-1x"></i>
  </a>
</nav>
</header>
<div id="main">
<h1 class="title">Portable, Repeatable (, and Reproducible) Notebooks</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgba272e8">Background</a>
<ul>
<li><a href="#org6a60922">Notebooks</a></li>
<li><a href="#org4af6b5d">Org-Mode (+ Emacs)</a></li>
</ul>
</li>
<li><a href="#org81e3c29">Caveats</a></li>
<li><a href="#orgd0d0607">Candidate Solution</a>
<ul>
<li><a href="#orgc68db55">Reproducible</a></li>
<li><a href="#orgffc3d50">Portable and Repeatable</a></li>
</ul>
</li>
<li><a href="#org69f6b2f">Discussion</a></li>
</ul>
</div>
</div>
<div class="PREVIEW">
<p>
Notebooks represent an important improvement for interactive and iterative
research.  However, they tend to lack portability, reproducibility, and
repeatability.  In this post, I want to explore the iterations of using <a href="https://orgmode.org/">Org
mode</a> notebooks combined with other tools to develop a (hopefully) portable,
reproducible, and repeatable notebook for software engineering experiments.
While the focus remains narrowed to software engineering, the tools and
techniques described should be applicable to any study requiring these
properties.
</p>

</div>

<p>
By using a number of techniques, it is easy to create notebooks which can be
passed along to collaborators, referees, and our future selves.  Importantly,
this post is <b>NOT</b> an introduction to <a href="https://orgmode.org/">Org Mode</a>, <a href="https://orgmode.org/worg/org-contrib/babel/">Org Babel</a>, or notebooks in
general.  The main contributions of this post is a series of techniques for <a href="https://orgmode.org/">Org
mode</a> to make the documents easily portable and repeatable with minimal fuss.
</p>

<div id="outline-container-orgba272e8" class="outline-2">
<h2 id="orgba272e8">Background</h2>
<div class="outline-text-2" id="text-orgba272e8">
<p>
There exists numerous examples of different "notebook" implementations, such as
<a href="https://jupyter.org/">Jupyter Notebooks</a>, <a href="https://www.sagemath.org/">SageMath Worksheets</a>, <a href="https://rmarkdown.rstudio.com/">R Markdown</a> and <a href="https://livebook.dev/">Elixir Livebook</a>; and
some less traditional ones, such as <a href="https://orgmode.org/">Org Mode</a> and tools such as <a href="https://mpastell.com/pweave/">Pweave</a>.
</p>
</div>

<div id="outline-container-org6a60922" class="outline-3">
<h3 id="org6a60922">Notebooks</h3>
<div class="outline-text-3" id="text-org6a60922">
<p>
<a href="https://jupyter.org/">Jupyter Notebooks</a> is arguably the most common and prevalent notebook system out
there, with many features.  It supports many features such as different
"kernels" to execute different languages, integrated documentation and code,
and inline plotting.  However, the underlying format is cumbersome and
difficult to use in collaboration with other developers using traditional tools
such as <a href="https://git-scm.com/">Git</a>.  For a larger list of issues with notebooks in general, see the
Caveats section below.
</p>
</div>
</div>

<div id="outline-container-org4af6b5d" class="outline-3">
<h3 id="org4af6b5d">Org-Mode (+ Emacs)</h3>
<div class="outline-text-3" id="text-org4af6b5d">
<p>
As an alternative, <a href="https://orgmode.org/">Org Mode</a> (with <a href="https://www.gnu.org/software/emacs/">Emacs</a>) offers all the desired features of
notebooks, but similarly gets around some of the limitations typical notebook
implementations impose.  For example, the notebook is manipulated directly in
your editor of choice(™); all creature comforts included.  Moreover, <a href="https://orgmode.org/worg/org-contrib/babel/">Org Babel</a>
offers the expected seamless integration between documentation and code blocks
and more.  For example, the code blocks within a notebook can be "tangled" out
and executed in a more typical command-line driven style.  Multi-kernel
notebooks are not common outside of a few extensions, such a feature is built
directly into <a href="https://orgmode.org/">Org Mode's</a> operation.  Moreover, computations from one snippet
can be input to another, in a different language.  For example, see the <a href="https://orgmode.org/worg/org-contrib/babel/intro.html#meta-programming-language">Meta
Programming Language</a> documentation.
</p>
</div>
</div>
</div>

<div id="outline-container-org81e3c29" class="outline-2">
<h2 id="org81e3c29">Caveats</h2>
<div class="outline-text-2" id="text-org81e3c29">
<p>
Notebooks are susceptible to a <a href="https://docs.google.com/presentation/d/1n2RlMdmv1p25Xy5thJUhkKGvjtV-dkAIsUXP-AL4ffI/edit#slide=id.g362da58057_0_1">number of issues</a> and <a href="https://orgmode.org/">Org mode</a> notebooks are no
exception.  These issues are not specifically addressed in this post, but they
absolutely require attention and acknowledgment.  Notably, state management and
"execution flow" are not straightforward concepts within notebooks since
developers can execute snippets in any order.
</p>

<p>
While not the standard way of interacting with notebooks, <a href="https://orgmode.org/">Org mode</a> provides a
mechanism for specifying code snippet/block dependency.  Its usage, however, is
restricted to when one block explicitly depends on the computational result of
another.  Specifically, using named variables to pass data between source
blocks imposes a computation dependency.  In this way, out of order execution
problems are alleviated, making the notebook easier to comprehend, even if the
format is not top-down.
</p>
</div>
</div>

<div id="outline-container-orgd0d0607" class="outline-2">
<h2 id="orgd0d0607">Candidate Solution</h2>
<div class="outline-text-2" id="text-orgd0d0607">
<p>
The following is <i>a</i> candidate solution to this problem.  It can and should be
refined, but it represents a decent step in the right direction.  First, we
discuss the "reproducible" component.  Then using an example, we discuss
portability and repeatability together.
</p>
</div>

<div id="outline-container-orgc68db55" class="outline-3">
<h3 id="orgc68db55">Reproducible</h3>
<div class="outline-text-3" id="text-orgc68db55">
<p>
<a href="https://guix.gnu.org/">GNU Guix</a> provides the necessary reproducibility.  Specifically, using <a href="https://github.com/purcell/envrc">envrc</a> and
<a href="https://direnv.net/">direnv</a>, a manifest is loaded and shimmed into the current environment within
<a href="https://www.gnu.org/software/emacs/">Emacs</a>.  In this way, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and other shell processes are using a specific
environment which includes the necessary tools and libraries for the project.
The same manifest is used to create a <a href="https://hpc.guix.info/blog/2020/05/faster-relocatable-packs-with-fakechroot/">"really reproducible"</a> package/archive
which is deployed to an HPC cluster.  This is all done using a channels file to
version pin the entire dependency tree (down to the C compiler and GLibC).
</p>
</div>
</div>

<div id="outline-container-orgffc3d50" class="outline-3">
<h3 id="orgffc3d50">Portable and Repeatable</h3>
<div class="outline-text-3" id="text-orgffc3d50">
<p>
For a recent conference paper, I needed to repeatedly run a few thousand
different experiments and then the aggregation and analysis of those
experiments.  This was accomplished with an <a href="https://orgmode.org/">Org mode</a> notebook.  The major
techniques discovered in the process are accessible properties, named example
blocks, and liberal use of header arguments.
</p>

<p>
The following are series of exerts directly from the notebook highlighting each
of these features.
</p>

<p>
The file was structured into several different headings, each for different
parts of the process.  The heading of the notebook had a few variables which
are used throughout the notebook:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold;">* notebook</span>
<span style="font-weight: bold;">:PROPERTIES:</span>
<span style="font-weight: bold;">:REMOTE:</span> borah.boisestate.edu
<span style="font-weight: bold;">:REMOTE-DIR:</span> /bsuhome/kennyballou/scratch
<span style="font-weight: bold;">:END:</span>
</pre>
</div>

<p>
Everything that interacts with the HPC cluster is then relative to these two
variables.  Another user can change these two variables and easily execute the
notebook.  For example, the following is a batch script which is "tangled" to
the HPC cluster.  Notice, the <code>:tangle</code> property uses these variables:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+begin_src bash :tangle (concat "/ssh:" (org-entry-get nil "REMOTE" t) ":" (org-entry-get nil "REMOTE-DIR" t) "/run-intervals-analysis.sh")</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">!/usr/bin/env bash</span>

<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH -N 1</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH -n 1</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH -c 4</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH --mem=64G</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH -t 0-03:00:00</span>
<span style="font-weight: bold; font-style: italic;">#</span><span style="font-weight: bold; font-style: italic;">SBATCH -p bsudfq</span>

module purge

<span style="font-weight: bold; font-style: italic;">RESULTS_PATH</span>=${<span style="font-weight: bold; font-style: italic;">1</span>}
<span style="font-weight: bold; font-style: italic;">CLASS_NAME</span>=${<span style="font-weight: bold; font-style: italic;">2</span>}
<span style="font-weight: bold; font-style: italic;">METHOD_ID</span>=${<span style="font-weight: bold; font-style: italic;">3</span>}

<span style="font-weight: bold;">exec</span> ~/DFA/bin/dfa interval-numerical <span style="font-style: italic;">\</span>
     --classpath ~/DFA/artifacts.jar <span style="font-style: italic;">\</span>
     --output <span style="font-style: italic;">"${RESULTS_PATH}"</span> <span style="font-style: italic;">\</span>
     <span style="font-style: italic;">"${CLASS_NAME}"</span> <span style="font-style: italic;">\</span>
     <span style="font-style: italic;">"${METHOD_ID}"</span>
<span style="font-weight: bold; font-style: italic;">#+end_src</span>
</pre>
</div>

<p>
Relative to the current notebook, we also have data files.  Many code blocks
need to refer to these data files throughout the experimental process.  To
accomplish this, they are named using example blocks:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+NAME: METHODS</span>
<span style="font-weight: bold; font-style: italic;">#+begin_example</span>
./in/methods.txt
<span style="font-weight: bold; font-style: italic;">#+end_example</span>

<span style="font-weight: bold; font-style: italic;">#+NAME: DOMAINS</span>
<span style="font-weight: bold; font-style: italic;">#+begin_example</span>
./in/domains.txt
<span style="font-weight: bold; font-style: italic;">#+end_example</span>

<span style="font-weight: bold; font-style: italic;">#+NAME: COMPARISONS</span>
<span style="font-weight: bold; font-style: italic;">#+begin_example</span>
./in/comparisons.txt
<span style="font-weight: bold; font-style: italic;">#+end_example</span>

<span style="font-weight: bold; font-style: italic;">#+NAME: REPORTS</span>
<span style="font-weight: bold; font-style: italic;">#+begin_example</span>
./in/reports.txt
<span style="font-weight: bold; font-style: italic;">#+end_example</span>
</pre>
</div>

<blockquote>
<p>
To take this a step further, the contents of the files themselves could be
included in the notebook directly and tangled out to the named paths.
</p>
</blockquote>

<p>
Finally, to uniquely identify different experiment runs, the following variable
is generated for each invocation:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+begin_src bash :eval query</span>
<span style="font-weight: bold;">echo</span> <span style="font-style: italic;">"#+NAME: UUID"</span>
<span style="font-weight: bold;">echo</span> -n $(uuidgen --time)
<span style="font-weight: bold; font-style: italic;">#+end_src</span>

<span style="font-weight: bold; font-style: italic;">#+RESULTS:</span>
<span style="font-weight: bold;">:results:</span>
<span style="font-weight: bold; font-style: italic;">#+NAME: UUID</span>
4cf8581e-e2c2-11ed-aab2-8cf8c5ed93dd
<span style="font-weight: bold;">:end:</span>
</pre>
</div>

<p>
Using this variable, we can create a relative path variable which is referenced
for the experiment and analysis output:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+NAME: OUTPUT_PREFIX</span>
<span style="font-weight: bold; font-style: italic;">#+begin_src bash :var UUID=(org-sbe UUID) :results silent</span>
<span style="font-weight: bold;">echo</span> -n <span style="font-style: italic;">"./out/${UUID}"</span>
<span style="font-weight: bold; font-style: italic;">#+end_src</span>
</pre>
</div>

<p>
Using a relative path for <code>OUTPUT_PREFIX</code> allows for the prefix to be used on the
remote servers and locally when processed data files are copied to the local
machine for exploratory analysis.
</p>

<p>
The <code>(org-sbe ...)</code> pattern is used frequently because it inherently removes any
newlines that may be introduced either by the literal text or if the variable
is computed from a previous source block.
</p>

<p>
Before jobs are submitted, the remote directory tree needs to be populated:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+begin_src bash :session *on-borah* :dir (concat "/ssh:" (org-entry-get nil "REMOTE" t) ":" (org-entry-get nil "REMOTE-DIR" t)) :results silent</span>
mkdir -p ${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/{joblogs,intervals}
<span style="font-weight: bold; font-style: italic;">#+end_src</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+begin_src bash :results silent</span>
scp -q <span style="font-style: italic;">"${METHODS}"</span> ${<span style="font-weight: bold; font-style: italic;">remote</span>}:${<span style="font-weight: bold; font-style: italic;">remote_dir</span>}/${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/methods.txt
scp -q <span style="font-style: italic;">"${DOMAINS}"</span> ${<span style="font-weight: bold; font-style: italic;">remote</span>}:${<span style="font-weight: bold; font-style: italic;">remote_dir</span>}/${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/domains.txt
scp -q <span style="font-style: italic;">"${COMPARISONS}"</span> ${<span style="font-weight: bold; font-style: italic;">remote</span>}:${<span style="font-weight: bold; font-style: italic;">remote_dir</span>}/${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/comparisons.txt
scp -q <span style="font-style: italic;">"${REPORTS}"</span> ${<span style="font-weight: bold; font-style: italic;">remote</span>}:${<span style="font-weight: bold; font-style: italic;">remote_dir</span>}/${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/reports.txt
rsync --archive ExperimentData/domains ${<span style="font-weight: bold; font-style: italic;">remote</span>}:${<span style="font-weight: bold; font-style: italic;">remote_dir</span>}/${<span style="font-weight: bold; font-style: italic;">OUTPUT_PREFIX</span>}/.
<span style="font-weight: bold; font-style: italic;">#+end_src</span>
</pre>
</div>

<p>
To keep the source blocks simple and reduce copying, we use <code>header-args</code> to
apply certain variables to all code blocks of a particular section.  For
example, "Job Initialization" has the following header arguments:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">**** Job Initialization</span>
<span style="font-weight: bold;">:PROPERTIES:</span>
<span style="font-weight: bold;">:ID:</span>       7e8302d4-38b7-4a3b-aed4-b329c81b43ce
<span style="font-weight: bold;">:header-args:bash:</span> :var OUTPUT_PREFIX=(org-sbe OUTPUT_PREFIX)
<span style="font-weight: bold;">:header-args:bash+:</span> :var METHODS=(org-sbe METHODS)
<span style="font-weight: bold;">:header-args:bash+:</span> :var DOMAINS=(org-sbe DOMAINS)
<span style="font-weight: bold;">:header-args:bash+:</span> :var COMPARISONS=(org-sbe COMPARISONS)
<span style="font-weight: bold;">:header-args:bash+:</span> :var REPORTS=(org-sbe REPORTS)
<span style="font-weight: bold;">:header-args:bash+:</span> :var remote=(org-entry-get nil "REMOTE" t)
<span style="font-weight: bold;">:header-args:bash+:</span> :var remote_dir=(org-entry-get nil "REMOTE-DIR" t)
<span style="font-weight: bold;">:END:</span>
</pre>
</div>

<p>
Finally, to execute a series of analyses, we use <a href="https://www.gnu.org/software/parallel/">GNU Parallel</a> to produce a
cross-product of our input parameters and submit the jobs against the remote machine:
</p>

<div class="org-src-container">
<pre class="src src-org"><span style="font-weight: bold; font-style: italic;">#+name: intervals</span>
<span style="font-weight: bold; font-style: italic;">#+begin_src bash</span>
parallel --colsep <span style="font-style: italic;">'\t'</span> <span style="font-style: italic;">\</span>
         --shuf <span style="font-style: italic;">\</span>
         --jobs=25% <span style="font-style: italic;">\</span>
         --delay 1s <span style="font-style: italic;">\</span>
         ssh -q ${<span style="font-weight: bold; font-style: italic;">remote</span>} <span style="font-style: italic;">\</span>
         sbatch --chdir=<span style="font-style: italic;">"${remote_dir}"</span> <span style="font-style: italic;">\</span>
         --job-name=<span style="font-style: italic;">"intervals-{1}_{2}"</span> <span style="font-style: italic;">\</span>
         --output=<span style="font-style: italic;">"${OUTPUT_PREFIX}/joblogs/%x.out"</span> <span style="font-style: italic;">\</span>
         --error=<span style="font-style: italic;">"${OUTPUT_PREFIX}/joblogs/%x.err"</span> <span style="font-style: italic;">\</span>
         run-intervals-analysis.sh <span style="font-style: italic;">"${OUTPUT_PREFIX}/intervals"</span> <span style="font-style: italic;">"{1}"</span> <span style="font-style: italic;">"{2}"</span> <span style="font-style: italic;">\</span>
         :::: <span style="font-style: italic;">"${METHODS}"</span>
<span style="font-weight: bold; font-style: italic;">#+end_src</span>
</pre>
</div>

<p>
Once the jobs are complete, we can download the results and begin the analysis
process.  However, that is essentially the same set of ideas repeated.
</p>
</div>
</div>
</div>

<div id="outline-container-org69f6b2f" class="outline-2">
<h2 id="org69f6b2f">Discussion</h2>
<div class="outline-text-2" id="text-org69f6b2f">
<p>
<a href="https://orgmode.org/">Org Mode</a> is a huge tool and requires a piecemeal consumption to master.  As
such, many examples using <a href="https://orgmode.org/worg/org-contrib/babel/">Org Babel</a>, for example, do not show the full power of
passing different arguments or using <a href="https://www.gnu.org/software/emacs/manual/elisp.html">Elisp</a> to directly manipulate and pass
variables to different source blocks.  Hopefully, this post can help fill those
gaps of what is possible with a meta-notebook tool like <a href="https://orgmode.org/">Org Mode</a>.
</p>

<p>
There are some obvious points of improvement.  First, <a href="https://guix.gnu.org/">Guix</a> and <a href="https://orgmode.org/">Org Mode</a> could
be better integrated such that a single notebook <i>can</i> be entirely
self-contained.  However, projects tend to be more than one file, so this is
not a major limitation.  More importantly, however, the process of submitting
jobs poses several limitations and problems.  <a href="https://slurm.schedmd.com/">SLURM</a> is not built for large job
submissions, thus, the delays and limited resources provided to <a href="https://www.gnu.org/software/parallel/">GNU parallel</a>,
which ultimately tie up <a href="https://www.gnu.org/software/emacs/">Emacs</a> for several minutes.  Furthermore, it can be
slightly problematic to have thousands of jobs waiting in SLURM's queue.  A
better approach would be to create <a href="https://slurm.schedmd.com/job_array.html">Job Arrays</a> for each set of experiments.
This would alleviate the pressure on <a href="https://slurm.schedmd.com/">SLURM</a> and keep <a href="https://www.gnu.org/software/emacs/">Emacs</a> from locking up
during the submission process.  Similarly, it would enable for the process to
be tangled out and sent to the cluster independently of <a href="https://www.gnu.org/software/emacs/">Emacs</a>.
</p>
</div>
</div>
</div>
<footer id="" class="status">
<footer>
  <p>&copy; 2014-2023 Kenny Ballou.
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Some rights
      reserved.</a></p>
  <p>Powered by <a href="https://gnu.org">GNU/Linux</a></p>
</footer>
</footer>
</body>
</html>
