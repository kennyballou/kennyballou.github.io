<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2022-05-25 Wed 15:08 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Releasing Elixir/OTP applications to the World</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="kb" />
<meta name="description" content="The perils of releasing OTP applications in the wild"
 />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<meta charset="utf-8">

<meta name="author" content="Kenny Ballou">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<title>~kb</title>

<link rel="canonical" href="/" />
<link href="/index.xml" rel="alternate" type="application/rss+xml"
      title="~kb/blog" />

<link rel="stylesheet" href="/css/simple.css" />
<link rel="stylesheet" href="/css/simple.add.css" />
<link rel="stylesheet" href="/css/katex.css" />
<link rel="stylesheet" href="/css/fa-all.css" />
<link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
<script defer type="text/javascript" src="/js/katex.js"></script>
<script defer type="text/javascript" src="/js/katex-render.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2019 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://kennyballou.com/blog"> UP </a>
 |
 <a accesskey="H" href="https://kennyballou.com/"> HOME </a>
</div><header id="" class="status">
<nav>
  <a href="/about.html">
    <i class="fade fas fa-user-circle"></i>
  </a>
  <a href="https://git.devnulllabs.io"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fas fa-code-branch fa-1x"></i>
  </a>
  <a href="https://github.com/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-github fa-1x"></i>
  </a>
  <a href="https://bitbucket.org/kballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-bitbucket fa-1x"></i>
  </a>
  <a href="https://twitter.com/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fab fa-twitter fa-1x"></i>
  </a>
  <a href="https://www.buymeacoffee.com/kennyballou"
     target="_blank"
     rel="noopener noreferrer">
    <i class="fade fas fa-mug-hot fa-1x"></i>
  </a>
  <a href="/resume.pdf"
     target="_blank">
    <i class="fade far fa-file-pdf"></i>
  </a>
  <a href="/932F3E8E1C0F4A9895D7B8B8B0CAA28A02958308.txt"
     target="_blank">
    <i class="fade fas fa-key"></i>
  </a>
  <a href="/index.xml" rel="alternate"
     type="application/rss+xml">
    <i class="fade fas fa-rss fa-1x"></i>
  </a>
</nav>
</header>
<div id="main">
<h1 class="title">Releasing Elixir/OTP applications to the World</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgcaf72bc">Problem</a>
<ul>
<li><a href="#orgd60157c">Shared Objects</a></li>
<li><a href="#orgfe9fcd8">Erlang Libraries</a></li>
<li><a href="#orgded0248">Docker or Virtualization</a></li>
<li><a href="#org5113bfc">OTP as Project Dependency</a></li>
</ul>
</li>
<li><a href="#org6f7cc74">Non-Solution Solutions</a></li>
<li><a href="#orgaf96f8e">Solutions(?)</a></li>
<li><a href="#org7a1b134">Moving Forward</a></li>
</ul>
</div>
</div>
<div class="PREVIEW">
<p>
Developing Elixir/OTP applications is an enlightening, mind-boggling, and
ultimately enjoyable experience.  There are so many features of the language
that change the very way we as developers think about concurrency and program
structure.  From writing pure functional code, to using message passing to
coordinate complex systems, it is one of the best languages for the SMP
revolution that has been slowly boiling under our feet.
</p>

</div>

<p>
However, <i>releasing</i> Elixir and OTP applications is an entirely different and
seemingly seldom discussed topic.
</p>

<p>
The distribution tool chain of Erlang and OTP is a complicated one, There's
<a href="http://erlang.org/doc/man/systools.html"><code>systools</code></a>, <a href="http://erlang.org/doc/man/reltool.html"><code>reltool</code></a>,
<a href="https://github.com/erlang/rebar3/releases"><code>rebar(?3)</code></a>, and <a href="https://github.com/erlware/relx"><code>relx</code></a> just to name a few that all
ultimately help in creating an Erlang/OTP <a href="http://erlang.org/doc/design_principles/release_structure.html">"release"</a>.
Similar to <code>rebar3</code>, <a href="https://github.com/bitwalker/exrm"><code>exrm</code></a> takes the high-level abstraction approach
to combining <code>reltool</code> and <code>relx</code> into a single tool chain for creating
releases of Elixir projects.  Of course, we can also borrow from the collection
of <a href="https://en.wikipedia.org/wiki/GNU_Build_System">autotools</a>.
</p>

<p>
There are plenty of articles and posts discussing how and why to use <code>exrm</code>.  I
feel many of them, however, fail to <i>truly</i> discuss <i>how</i> to do this
effectively.  Most will mention the surface of the issue, but never give the
issue any real attention.  As any developer that wants to eventually <i>ship</i>
code, this is entirely too frustrating to leave alone.
</p>

<p>
There are "ways" of deploying OTP code relatively simply, however, these
methods generally avoid good practice of continuous integration/continuous
deployment, e.g., "build the OTP application <i>on</i> the target system" or simply
use <code>mix run</code>, etc.
</p>

<p>
I cannot speak for everyone, but my general goal is to <i>not</i> have such a manual
step in my release pipeline, let alone having a possibly full autotool chain
and Erlang/Elixir stack on the production system is slightly unnerving for it's
own set of reasons.
</p>

<div id="outline-container-orgcaf72bc" class="outline-2">
<h2 id="orgcaf72bc"><a id="ID-a5bb175a-373c-45ee-b686-1a6fd9254859"></a>Problem</h2>
<div class="outline-text-2" id="text-orgcaf72bc">
<p>
Here are some selected quotes; I'm not trying to pick on anyone in particular
or the community at large, but I'm trying to show a representation of why this
very topic is an issue in the first place.
</p>

<blockquote>
<p>
We need to be sure that the architectures for both our build and hosting
environments are the same, e.g. 64-bit Linux -&gt; 64-bit Linux.  If the
architectures don't match, our application might not run when deployed.
Using a virtual machine that mirrors our hosting environment as our build
environment is an easy way to avoid that problem.
<a href="http://www.phoenixframework.org/docs/advanced-deployment">Phoenix Exrm Releases</a>.
</p>
</blockquote>

<p>
And another, similar quote:
</p>

<blockquote>
<p>
One important thing to note, however: <i>you must use the same architecture for
building your release that the release is getting deployed to.</i> If your
development machine is OS X and you're deploying to a Linux server, you need
a Linux machine to build your exrm release or it isn't going to work, or you
can just build on the same server you're going to be running everything on.
<a href="https://erlang-solutions.com">Brandon Richey</a>.
</p>
</blockquote>

<p>
Unfortunately, these miss a lot of the more subtle issues, dependency hell is
real, and we're about to really dive into it.
</p>

<p>
There are a few examples where "same architecture" isn't enough, and this is
where we will spend the majority of our time.
</p>

<p>
For these examples, we will assume our host machine is running GNU/Linux,
specifically Arch Linux, and our target machine is running CentOS 7.2.  Both
machines are running the <code>AMD64</code> instruction sets, the architectures are the
<i>same</i>.
</p>
</div>

<div id="outline-container-orgd60157c" class="outline-3">
<h3 id="orgd60157c"><a id="ID-93561071-f3ac-4bbc-a24d-4977bd78a317"></a>Shared Objects</h3>
<div class="outline-text-3" id="text-orgd60157c">
<p>
Let's start with the most simplistic issue, different versions of shared
objects.
</p>

<p>
Arch Linux is a rolling release distribution that is generally <i>right</i> on the
bleeding edge of packages, upstream is usually the development sources
themselves.  When <code>ncurses</code> moves version 6, Arch isn't far behind in putting
it in the stable package repository (and rebuilding a number of packages that
depend on <code>ncurses</code>).  CentOS, on the other hand, is not so aggressive.
Therefore, when using the default <code>relx</code> configuration with <code>exrm</code>, the Erlang
runtime system (ERTS) bundled with the release <i>will</i> be incompatible with the
target system.
</p>

<p>
When the OTP application is started, an obscure linking error will be emitted
complaining about how ERTS cannot find a <code>ncurses.so.6</code> file and promptly fail.
</p>

<p>
Worse, after possibly "fixing" this issue, <code>ncurses</code> is only one of a few
shared objects Erlang needs to run, depending on what was enabled when Erlang
was built or what features the deployed application needs.
</p>
</div>
</div>

<div id="outline-container-orgfe9fcd8" class="outline-3">
<h3 id="orgfe9fcd8"><a id="ID-46a3fda1-6ecd-428d-9354-97561f9a0dbb"></a>Erlang Libraries</h3>
<div class="outline-text-3" id="text-orgfe9fcd8">
<p>
We may try to resolve this issue by adding a particular <code>rel/relx.config</code> file
to our Elixir project.  Specifically, we will <i>not</i> bundle ERTS, opting to use
the target's ERTS instead.
</p>

<pre class="example">
{include_erts, false}.
</pre>

<p>
This seems like a promising approach, until another error message is emitted at
startup, namely, ERTS cannot find <code>stdlib-2.8</code> in the <code>/usr/lib/erlang/lib</code>
folder.
</p>

<p>
Did I mention that our current build system is Arch and our target is CentOS?
Arch may have the <i>newest</i> version of Erlang in the repository and CentOS is
still at whatever it was at before: R16B unless the
<a href="https://erlang-solutions.com">Erlang Solutions</a> release is being used.
</p>

<p>
Since Erlang applications do (patch number) version locking, applications in
the dependency tree will need to match exactly and it's guaranteed that any and
all OTP applications will be at least depending on the Erlang kernel and the
Erlang standard library, these are at least two OTP applications <i>our</i>
application is going to need that are <i>no longer packaged when <code>relx</code> doesn't
bundle ERTS</i>.
</p>

<p>
Even if we specify another option to <code>relx</code>, namely, <code>{system_libs, true}.</code>, we
are left with the same lack of Erlang system libraries.
</p>

<p>
That's correct and there is some sensible reasons for this.  If we ask <code>exrm</code>
and therefore <code>relx</code> to not include the build system's ERTS, we are <i>also</i>
excluding the standard Erlang libraries from the release as well, asking to
include the standard libraries of the build system's ERTS could run into the
<i>very</i> same issues as above for a whole host of other reasons.
</p>

<p>
We are left to attempt more solutions.
</p>
</div>
</div>

<div id="outline-container-orgded0248" class="outline-3">
<h3 id="orgded0248"><a id="ID-12db9648-3a15-4deb-b367-8f276f2bf1f6"></a>Docker or Virtualization</h3>
<div class="outline-text-3" id="text-orgded0248">
<p>
Next, since we do want to ultimately get our build running in a CI/CD
environment, we may look toward virutalization/containerization.  Being
sensible people, we try to use a small image, maybe basing our image on
<a href="http://alpinelinux.org">Alpine Linux</a> as to be nice to our precious <code>/var</code> or SSD
space.  We may even go so far as to build Erlang and Elixir ourselves in these
images to make sure we have the most control over them as we can.  Furthermore,
since we are building everything ourself, shipping the built ERTS seems like a
good idea too, so we can delete the <code>rel/relx.config</code> file.
</p>

<p>
This seems promising.  However, we have shared object problems again.  Since we
are building Erlang and Elixir ourselves, we decided to disable <code>termcap</code>
support thus no longer requiring the <code>ncurses</code> library altogether.  We hope
that the <code>openssl</code> libraries are the same, so we don't have to worry about that
mess, and we move on.
</p>

<p>
This time, when we attempt to deploy the application, we get a different,
obscure error: something about our <code>musl</code> C library isn't found on the target
system.  Right, because we are trying to create a small image, we opted to use
the <code>musl</code> C library because of its size and being easily supported in the
Alpine Linux container.  Trying to use GNU C library is too cumbersome and
would only inflate the image beyond any gains we would achieve by using Alpine
in the first place.
</p>

<p>
That's not going to work.
</p>
</div>
</div>

<div id="outline-container-org5113bfc" class="outline-3">
<h3 id="org5113bfc"><a id="ID-5a4802cf-76c3-4794-8616-b6a897386daf"></a>OTP as Project Dependency</h3>
<div class="outline-text-3" id="text-org5113bfc">
<p>
Another option we might try is make Erlang a build dependency of our Elixir
application, this <i>could</i> be achieved via the following structure:
</p>

<pre class="example">
{:otp,
 "~&gt; 18.3.2",
 github: "erlang/otp",
 tag: "OTP-18.3.2",
 only: :prod,
 compile: "./otp_build autoconf;" &lt;&gt;
          "./configure --without-termcap --without-javac;" &lt;&gt;
          "make -j4" &lt;&gt;
          "DISTDIR=/tmp/erlang make install"
}
</pre>

<p>
Then using <code>rel/relx.config</code> with:
</p>

<pre class="example">
{include_erts, "/tmp/erlang"}.
</pre>

<p>
<i>May</i> turn out to work, assuming the build server and the target system have
the same shared objects for OpenSSL and others that may be enabled by default.
</p>

<blockquote>
<p>
However, I didn't follow this idea all the way to the end as I wasn't
entirely happy with it, and it would fall to some later issues.
</p>
</blockquote>

<p>
Notably, though, this will inflate the production builds drastically since our
<code>mix deps.get</code> and <code>mix deps.compile</code> steps will hang attempting to build
Erlang itself.
</p>

<p>
However, again, we will likely run into issues with the C library used by the
build system/container.  Going this route doesn't allow us to use Alpine Linux
either.
</p>

<p>
Worse, there's another issue that hasn't even shown itself but is lying in
wait: native implemented (or interface) functions (NIFs).
</p>

<p>
If our project has a dependency that builds a NIF as part of its build
(Elixir's <a href="https://hex.pm/packages/comeonin">comeonin</a> is a good example of this), unless the NIF
is statically compiled, we are back to square one and shared objects are not
our friends.  Furthermore, if we are using a different standard library
implementation, i.e., <code>musl</code> vs <code>glibc</code>, the dependency will likely complain
about it as well.
</p>
</div>
</div>
</div>

<div id="outline-container-org6f7cc74" class="outline-2">
<h2 id="org6f7cc74"><a id="ID-36bda176-eb6a-412b-b7a8-2102e4cbcd36"></a>Non-Solution Solutions</h2>
<div class="outline-text-2" id="text-org6f7cc74">
<p>
Of course, all of these above issues can be solved by "just building on the
target machine" or by simply using <code>mix run</code> on the target instead.  However, I
personally find these solutions unacceptable.
</p>

<p>
I'm not overly fond of requiring my target hosts, my production machines,
running a full development tool chain.  Before this is dismissed as a personal
issue, remember that our dependency tree may contain NIFs outside of our
control.  Therefore, it's not just Erlang/Elixir that are required to be on the
machine, but a C standard library and autotools too.
</p>

<p>
This solution doesn't immediately give the impression of scaling architecture.
If a new release needs to be deployed, each server will now need to spare some
load for building the project and its dependencies before any real, actual
upgrading can continue.
</p>
</div>
</div>

<div id="outline-container-orgaf96f8e" class="outline-2">
<h2 id="orgaf96f8e"><a id="ID-d1fa6111-c61b-4dea-890d-6736dbe20fb7"></a>Solutions(?)</h2>
<div class="outline-text-2" id="text-orgaf96f8e">
<p>
What are we to do? How are we to build Erlang/Elixir/OTP applications as part
of our CI/CD pipeline? Particularly, how are we to build our applications on a
CI/CD system and <i>not</i> the production box(es) themselves?
</p>

<p>
If any of the above problems tell us anything, it's that the build system must
be either the <i>exact same</i> machine or clone with build tools.  Thankfully, we
can achieve a "clone" without too much work using <a href="https://docker.com">Docker</a> and the
<a href="https://hub.docker.com/explore/">official image registries</a>.
</p>

<p>
By using the official CentOS image and a specific tag, we can match our target
system almost exactly.  Furthermore, building the Erlang/Elixir stack from
source is a relatively small order for a Docker container too, making
versioning completely within reach.  Moreover, since the build host and the
target host are nearly identical, bundling ERTS should be a non-issue.
</p>

<blockquote>
<p>
This is the observed result of using
<a href="https://github.com/kennyballou/docker-elixir-centos">docker-elixir-centos</a> for a base image for CI
builds.
</p>
</blockquote>

<p>
Another possible solution is to ship Docker containers as the artifact of the
build.  However, this, to do well, requires a decent Docker capable
infrastructure and deployment process.  Furthermore, going this route, it's
unlikely that <code>exrm</code> is even necessary at all.  It is likely more appropriate
to simply use <code>mix run</code> or whatever the project's equivalent is.  Another thing
lost here, is <a href="http://erlang.org/doc/man/reltool.html">relups</a>, which is essentially the whole
reason of wanting to use <code>exrm</code> in the first place.
</p>

<p>
As such, if using <code>exrm</code> is desired, setting up a build server will be
imperative to building reliably and without building on production.  Scaling
from a solid build foundation will be much easier than building and "deploying"
on the production farm itself.
</p>
</div>
</div>

<div id="outline-container-org7a1b134" class="outline-2">
<h2 id="org7a1b134"><a id="ID-c863c3c8-9535-4309-9961-b87d44213b98"></a>Moving Forward</h2>
<div class="outline-text-2" id="text-org7a1b134">
<p>
Releasing software isn't in a particularly hard class of problems, but it does
have its challenges.  Some languages attempt to solve this challenge in its
artifact/build result.  Other languages, unfortunately, don't attempt to solve
this problem at all.  Though, I can see it possible to eventually reach a goal
of being able to create binary releases with steps as simple as <code>./configure &amp;&amp;
make &amp;&amp; make install &amp;&amp; tar</code>.
</p>

<p>
But we aren't there yet.
</p>

<p>
But we are close.
</p>

<p>
The current way Erlang/OTP applications want to be deployed includes wanting to
ship <i>with</i> the runtime, this is a great starting point.
</p>

<p>
To move to a better, easier release cycle, we need a few things:
</p>

<ul class="org-ul">
<li>The ability to (natively) cross-compile to different architectures and
different versions of ERTS <i>and</i> cross-compile Erlang code itself.</li>

<li>The ability to easily statically compile ERTS and bundle the result for the
specified architecture.</li>
</ul>

<p>
Cross-compiling to different versions of ERTS is likely a harder problem to
tackle.  But being able to cross-compile the ERTS itself is likely much easier
since this is already a <a href="https://www.gnu.org/software/automake/manual/html_node/Cross_002dCompilation">feature</a> of GCC.
</p>

<p>
Thus, our problem is now how do we add and/or expose the facility of
customizing the appropriate build flags to our projects and dependencies to
cross-compile a static ERTS and any NIFs and bundle these into a solid OTP
release.
</p>
</div>
</div>
</div>
<footer id="" class="status">
<footer>
  <p>&copy; 2014-2022 Kenny Ballou.
    <a href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Some rights
      reserved.</a></p>
  <p>Powered by <a href="https://gnu.org">GNU/Linux</a></p>
</footer>
</footer>
</body>
</html>
